#include "text.h"
#include <string.h>
#include <ctype.h>

/* Stroke font: each character is defined as line segments in a 0..1 cell.
 * Each segment is 4 floats: x0, y0, x1, y1 (origin top-left, y down). */
#define MAX_STROKES 8

typedef struct {
    float segs[MAX_STROKES][4]; /* up to MAX_STROKES line segments */
    int   count;
} Glyph;

static Glyph glyphs[128];
static int initialized = 0;

#define G(ch, n, ...) do { \
    float _s[][4] = { __VA_ARGS__ }; \
    glyphs[(int)(ch)].count = (n); \
    for (int _i = 0; _i < (n); _i++) \
        for (int _j = 0; _j < 4; _j++) \
            glyphs[(int)(ch)].segs[_i][_j] = _s[_i][_j]; \
} while(0)

void text_init(void)
{
    if (initialized) return;
    initialized = 1;
    memset(glyphs, 0, sizeof(glyphs));

    /* Digits */
    G('0', 6,
      {0.1,0, 0.9,0}, {0.9,0, 0.9,1}, {0.9,1, 0.1,1},
      {0.1,1, 0.1,0}, {0.1,0, 0.9,1}, {0,0, 0,0}); glyphs['0'].count=5;
    G('1', 2,
      {0.5,0, 0.5,1}, {0.2,1, 0.8,1});
    G('2', 5,
      {0.1,0, 0.9,0}, {0.9,0, 0.9,0.5}, {0.9,0.5, 0.1,0.5},
      {0.1,0.5, 0.1,1}, {0.1,1, 0.9,1});
    G('3', 4,
      {0.1,0, 0.9,0}, {0.9,0, 0.9,1}, {0.9,1, 0.1,1},
      {0.1,0.5, 0.9,0.5});
    G('4', 3,
      {0.1,0, 0.1,0.5}, {0.1,0.5, 0.9,0.5}, {0.9,0, 0.9,1});
    G('5', 5,
      {0.9,0, 0.1,0}, {0.1,0, 0.1,0.5}, {0.1,0.5, 0.9,0.5},
      {0.9,0.5, 0.9,1}, {0.9,1, 0.1,1});
    G('6', 5,
      {0.9,0, 0.1,0}, {0.1,0, 0.1,1}, {0.1,1, 0.9,1},
      {0.9,1, 0.9,0.5}, {0.9,0.5, 0.1,0.5});
    G('7', 2,
      {0.1,0, 0.9,0}, {0.9,0, 0.5,1});
    G('8', 5,
      {0.1,0, 0.9,0}, {0.9,0, 0.9,1}, {0.9,1, 0.1,1},
      {0.1,1, 0.1,0}, {0.1,0.5, 0.9,0.5});
    G('9', 5,
      {0.1,1, 0.9,1}, {0.9,1, 0.9,0}, {0.9,0, 0.1,0},
      {0.1,0, 0.1,0.5}, {0.1,0.5, 0.9,0.5});

    /* Letters */
    G('A', 3,
      {0.0,1, 0.5,0}, {0.5,0, 1.0,1}, {0.2,0.6, 0.8,0.6});
    G('B', 7,
      {0.1,0, 0.1,1}, {0.1,0, 0.7,0}, {0.7,0, 0.8,0.15},
      {0.8,0.15, 0.7,0.5}, {0.1,0.5, 0.7,0.5},
      {0.7,0.5, 0.8,0.85}, {0.8,0.85, 0.1,1});
    G('C', 3,
      {0.9,0, 0.1,0}, {0.1,0, 0.1,1}, {0.1,1, 0.9,1});
    G('D', 4,
      {0.1,0, 0.1,1}, {0.1,0, 0.7,0}, {0.7,0, 0.9,0.5},
      {0.9,0.5, 0.1,1});
    G('E', 4,
      {0.9,0, 0.1,0}, {0.1,0, 0.1,1}, {0.1,1, 0.9,1},
      {0.1,0.5, 0.7,0.5});
    G('F', 3,
      {0.9,0, 0.1,0}, {0.1,0, 0.1,1}, {0.1,0.5, 0.7,0.5});
    G('G', 5,
      {0.9,0, 0.1,0}, {0.1,0, 0.1,1}, {0.1,1, 0.9,1},
      {0.9,1, 0.9,0.5}, {0.9,0.5, 0.5,0.5});
    G('H', 3,
      {0.1,0, 0.1,1}, {0.9,0, 0.9,1}, {0.1,0.5, 0.9,0.5});
    G('I', 3,
      {0.3,0, 0.7,0}, {0.5,0, 0.5,1}, {0.3,1, 0.7,1});
    G('J', 3,
      {0.3,0, 0.9,0}, {0.7,0, 0.7,1}, {0.7,1, 0.1,1});
    G('K', 3,
      {0.1,0, 0.1,1}, {0.9,0, 0.1,0.5}, {0.1,0.5, 0.9,1});
    G('L', 2,
      {0.1,0, 0.1,1}, {0.1,1, 0.9,1});
    G('M', 4,
      {0.0,1, 0.0,0}, {0.0,0, 0.5,0.5}, {0.5,0.5, 1.0,0}, {1.0,0, 1.0,1});
    G('N', 3,
      {0.1,1, 0.1,0}, {0.1,0, 0.9,1}, {0.9,1, 0.9,0});
    G('O', 4,
      {0.1,0, 0.9,0}, {0.9,0, 0.9,1}, {0.9,1, 0.1,1}, {0.1,1, 0.1,0});
    G('P', 4,
      {0.1,0, 0.1,1}, {0.1,0, 0.9,0}, {0.9,0, 0.9,0.5}, {0.9,0.5, 0.1,0.5});
    G('Q', 5,
      {0.1,0, 0.9,0}, {0.9,0, 0.9,1}, {0.9,1, 0.1,1},
      {0.1,1, 0.1,0}, {0.6,0.7, 1.0,1.0});
    G('R', 5,
      {0.1,0, 0.1,1}, {0.1,0, 0.9,0}, {0.9,0, 0.9,0.5},
      {0.9,0.5, 0.1,0.5}, {0.5,0.5, 0.9,1});
    G('S', 5,
      {0.9,0, 0.1,0}, {0.1,0, 0.1,0.5}, {0.1,0.5, 0.9,0.5},
      {0.9,0.5, 0.9,1}, {0.9,1, 0.1,1});
    G('T', 2,
      {0.0,0, 1.0,0}, {0.5,0, 0.5,1});
    G('U', 3,
      {0.1,0, 0.1,1}, {0.1,1, 0.9,1}, {0.9,1, 0.9,0});
    G('V', 2,
      {0.0,0, 0.5,1}, {0.5,1, 1.0,0});
    G('W', 4,
      {0.0,0, 0.2,1}, {0.2,1, 0.5,0.5}, {0.5,0.5, 0.8,1}, {0.8,1, 1.0,0});
    G('X', 2,
      {0.1,0, 0.9,1}, {0.9,0, 0.1,1});
    G('Y', 3,
      {0.0,0, 0.5,0.5}, {1.0,0, 0.5,0.5}, {0.5,0.5, 0.5,1});
    G('Z', 3,
      {0.1,0, 0.9,0}, {0.9,0, 0.1,1}, {0.1,1, 0.9,1});

    /* Punctuation */
    G('.', 1, {0.45,0.9, 0.55,1.0});
    G(',', 1, {0.5,0.9, 0.4,1.1});
    G(':', 2, {0.45,0.25, 0.55,0.35}, {0.45,0.65, 0.55,0.75});
    G('-', 1, {0.2,0.5, 0.8,0.5});
    G('/', 1, {0.1,1, 0.9,0});

    /* Degree symbol: small circle at top-right */
    G('^', 4,
      {0.3,0, 0.7,0}, {0.7,0, 0.7,0.3}, {0.7,0.3, 0.3,0.3}, {0.3,0.3, 0.3,0});
}

int text_build(const char *str, float x, float y, float size,
               float *out_verts, int max_verts)
{
    int vcount = 0;
    float cx = x;
    float char_w = size * 0.7f;
    float gap = size * 0.15f;

    for (int i = 0; str[i]; i++) {
        char ch = str[i];

        if (ch == ' ') {
            cx += char_w * 0.6f;
            continue;
        }

        /* Map lowercase to uppercase */
        if (ch >= 'a' && ch <= 'z') ch = ch - 'a' + 'A';

        /* Use '^' internally for degree symbol */
        int idx = (unsigned char)ch;
        if (idx >= 128) idx = '^'; /* treat extended chars (like Â°) as degree */

        const Glyph *g = &glyphs[idx];
        if (g->count == 0) {
            cx += char_w;
            continue;
        }

        for (int s = 0; s < g->count; s++) {
            if (vcount + 2 > max_verts) return vcount;

            float x0 = cx + g->segs[s][0] * char_w;
            float y0 = y  + g->segs[s][1] * size;
            float x1 = cx + g->segs[s][2] * char_w;
            float y1 = y  + g->segs[s][3] * size;

            out_verts[vcount * 2]     = x0;
            out_verts[vcount * 2 + 1] = y0;
            vcount++;
            out_verts[vcount * 2]     = x1;
            out_verts[vcount * 2 + 1] = y1;
            vcount++;
        }

        cx += char_w + gap;
    }

    return vcount;
}
